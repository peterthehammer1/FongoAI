<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Details - Fongo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #16325c;
            --success: #04844b;
            --error: #c23934;
            --warning: #ffb75d;
            --text-primary: #16325c;
            --text-secondary: #706e6b;
            --border: #d8dde6;
            --bg-light: #f3f3f3;
            --bg-white: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        /* Navigation */
        .navbar {
            background: var(--secondary);
            color: white;
            padding: 0;
            box-shadow: var(--shadow-lg);
        }

        .navbar-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .navbar-brand img {
            height: 32px;
        }

        .btn-back {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Status Banner */
        .status-banner {
            background: var(--bg-white);
            padding: 20px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-banner.success {
            border-left-color: var(--success);
        }

        .status-banner.error {
            border-left-color: var(--error);
        }

        .status-content h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-content p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-badge.success {
            background: #d4edda;
            color: var(--success);
        }

        .status-badge.error {
            background: #f8d7da;
            color: var(--error);
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-card {
            background: var(--bg-white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .info-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            text-align: right;
        }

        /* Error Card */
        .error-card {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .error-card h3 {
            color: var(--error);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-card p {
            color: #742a2a;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        /* Comprehensive Sections */
        .comprehensive-section {
            background: var(--bg-white);
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .section-header:hover {
            background: var(--bg-light);
        }

        .section-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header i.fa-chevron-down {
            transition: transform 0.3s;
        }

        .section-header.collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 24px;
            display: block;
        }

        .section-content.collapsed {
            display: none;
        }

        .info-card h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .btn-small {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: var(--primary-dark);
        }

        /* Transcript Section */
        .transcript-section {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .transcript-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .transcript-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.agent {
            flex-direction: row;
        }

        .message.customer {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.agent .message-avatar {
            background: var(--primary);
            color: white;
        }

        .message.customer .message-avatar {
            background: var(--text-secondary);
            color: white;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.agent .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.customer .message-bubble {
            background: #e9ecef;
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            padding: 0 4px;
        }

        .message.agent .message-time {
            text-align: left;
        }

        .message.customer .message-time {
            text-align: right;
        }

        /* Webhook Data Section */
        .webhook-section {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .webhook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .webhook-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .webhook-content {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .btn-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-toggle:hover {
            background: var(--primary-dark);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 32px;
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
                <img src="/Images/fongo-wp-logo-white.svg" alt="Fongo" onerror="this.style.display='none'">
                <span>Call Details</span>
            </div>
            <button class="btn-back" onclick="window.location.href='/dashboard'">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </button>
        </div>
    </nav>

    <!-- Container -->
    <div class="container">
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner"></i>
            <div>Loading call details...</div>
        </div>

        <div id="contentArea" style="display: none;">
            <!-- Status Banner -->
            <div class="status-banner" id="statusBanner">
                <div class="status-content">
                    <h2 id="statusTitle">Payment Update Status</h2>
                    <p id="statusDescription">Loading...</p>
                </div>
                <div class="status-badge" id="statusBadge">Loading...</div>
            </div>

            <!-- Error Card -->
            <div class="error-card" id="errorCard" style="display: none;">
                <h3><i class="fas fa-exclamation-triangle"></i> Payment Update Failed</h3>
                <p id="errorMessage"></p>
            </div>

            <!-- Info Grid -->
            <div class="info-grid">
                <div class="info-card">
                    <h3>Call Information</h3>
                    <div class="info-row">
                        <span class="info-label">Call ID</span>
                        <span class="info-value" id="callId">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Date & Time</span>
                        <span class="info-value" id="callDateTime">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Duration</span>
                        <span class="info-value" id="callDuration">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone Number</span>
                        <span class="info-value" id="callerNumber">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Caller Name</span>
                        <span class="info-value" id="callerName">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>Payment Information</h3>
                    <div class="info-row">
                        <span class="info-label">Card Type</span>
                        <span class="info-value" id="cardType">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last 4 Digits</span>
                        <span class="info-value" id="cardLast4">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Expiry Date</span>
                        <span class="info-value" id="cardExpiry">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cardholder Name</span>
                        <span class="info-value" id="cardholderName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Language</span>
                        <span class="info-value" id="language">-</span>
                    </div>
                </div>
            </div>

            <!-- Core Call Data Section -->
            <div class="comprehensive-section" id="coreCallDataSection" style="display: none;">
                <div class="section-header" onclick="toggleSection('coreCallData')">
                    <h3><i class="fas fa-phone"></i> Core Call Data</h3>
                    <i class="fas fa-chevron-down" id="coreCallDataIcon"></i>
                </div>
                <div class="section-content" id="coreCallDataContent">
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Call Details</h4>
                            <div class="info-row">
                                <span class="info-label">Call Type</span>
                                <span class="info-value" id="callType">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Call Status</span>
                                <span class="info-value" id="callStatus">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Direction</span>
                                <span class="info-value" id="direction">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">From Number</span>
                                <span class="info-value" id="fromNumber">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">To Number</span>
                                <span class="info-value" id="toNumber">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Disconnection Reason</span>
                                <span class="info-value" id="disconnectionReason">-</span>
                            </div>
                        </div>
                        <div class="info-card">
                            <h4>Agent Information</h4>
                            <div class="info-row">
                                <span class="info-label">Agent ID</span>
                                <span class="info-value" id="agentId">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Agent Name</span>
                                <span class="info-value" id="agentName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Agent Version</span>
                                <span class="info-value" id="agentVersion">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Start Time</span>
                                <span class="info-value" id="startTimestamp">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">End Time</span>
                                <span class="info-value" id="endTimestamp">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Duration (ms)</span>
                                <span class="info-value" id="durationMs">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transcript & Recording Section -->
            <div class="comprehensive-section" id="transcriptRecordingSection" style="display: none;">
                <div class="section-header" onclick="toggleSection('transcriptRecording')">
                    <h3><i class="fas fa-file-audio"></i> Transcript & Recording Data</h3>
                    <i class="fas fa-chevron-down" id="transcriptRecordingIcon"></i>
                </div>
                <div class="section-content" id="transcriptRecordingContent">
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Recordings & Logs</h4>
                            <div class="info-row" id="recordingUrlRow" style="display: none;">
                                <span class="info-label">Standard Recording</span>
                                <span class="info-value"><a href="#" id="recordingUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-play-circle"></i> Listen</a></span>
                            </div>
                            <div class="info-row" id="recordingMultiChannelRow" style="display: none;">
                                <span class="info-label">Multi-Channel Recording</span>
                                <span class="info-value"><a href="#" id="recordingMultiChannelUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-play-circle"></i> Listen</a></span>
                            </div>
                            <div class="info-row" id="scrubbedRecordingRow" style="display: none;">
                                <span class="info-label">Scrubbed Recording</span>
                                <span class="info-value"><a href="#" id="scrubbedRecordingUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-play-circle"></i> Listen</a></span>
                            </div>
                            <div class="info-row" id="scrubbedMultiChannelRow" style="display: none;">
                                <span class="info-label">Scrubbed Multi-Channel</span>
                                <span class="info-value"><a href="#" id="scrubbedMultiChannelUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-play-circle"></i> Listen</a></span>
                            </div>
                            <div class="info-row" id="publicLogRow" style="display: none;">
                                <span class="info-label">Public Log</span>
                                <span class="info-value"><a href="#" id="publicLogUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-file-alt"></i> View</a></span>
                            </div>
                            <div class="info-row" id="scrubbedPublicLogRow" style="display: none;">
                                <span class="info-label">Scrubbed Public Log</span>
                                <span class="info-value"><a href="#" id="scrubbedPublicLogUrl" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-file-alt"></i> View</a></span>
                            </div>
                        </div>
                        <div class="info-card">
                            <h4>Transcript Variants</h4>
                            <div class="info-row">
                                <span class="info-label">Plain Text</span>
                                <span class="info-value" id="transcriptAvailable">Available</span>
                            </div>
                            <div class="info-row" id="transcriptObjectRow" style="display: none;">
                                <span class="info-label">Structured Transcript</span>
                                <span class="info-value"><button class="btn-small" onclick="showTranscriptObject()">View</button></span>
                            </div>
                            <div class="info-row" id="transcriptToolCallsRow" style="display: none;">
                                <span class="info-label">With Tool Calls</span>
                                <span class="info-value"><button class="btn-small" onclick="showTranscriptWithToolCalls()">View</button></span>
                            </div>
                            <div class="info-row" id="scrubbedTranscriptRow" style="display: none;">
                                <span class="info-label">Scrubbed (PII Removed)</span>
                                <span class="info-value"><button class="btn-small" onclick="showScrubbedTranscript()">View</button></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis & Insights Section -->
            <div class="comprehensive-section" id="analysisSection" style="display: none;">
                <div class="section-header" onclick="toggleSection('analysis')">
                    <h3><i class="fas fa-chart-line"></i> Analysis & Insights</h3>
                    <i class="fas fa-chevron-down" id="analysisIcon"></i>
                </div>
                <div class="section-content" id="analysisContent">
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Call Analysis</h4>
                            <div class="info-row">
                                <span class="info-label">Call Successful</span>
                                <span class="info-value" id="callSuccessful">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">User Sentiment</span>
                                <span class="info-value" id="userSentiment">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">In Voicemail</span>
                                <span class="info-value" id="inVoicemail">-</span>
                            </div>
                            <div class="info-row" id="callSummaryRow" style="display: none;">
                                <span class="info-label">Call Summary</span>
                                <span class="info-value" id="callSummary" style="white-space: pre-wrap; text-align: left;">-</span>
                            </div>
                        </div>
                        <div class="info-card">
                            <h4>Detailed Analysis</h4>
                            <div class="info-row" id="callAnalysisRow" style="display: none;">
                                <span class="info-label">Full Analysis</span>
                                <span class="info-value"><button class="btn-small" onclick="showCallAnalysis()">View</button></span>
                            </div>
                            <div class="info-row" id="customAnalysisRow" style="display: none;">
                                <span class="info-label">Custom Analysis</span>
                                <span class="info-value"><button class="btn-small" onclick="showCustomAnalysis()">View</button></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transcript Section -->
            <div class="transcript-section">
                <div class="transcript-header">
                    <h3><i class="fas fa-comments"></i> Call Transcript</h3>
                </div>
                <div class="transcript-container" id="transcriptContainer">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <div>Loading transcript...</div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics Section -->
            <div class="comprehensive-section" id="performanceMetricsSection" style="display: none;">
                <div class="section-header" onclick="toggleSection('performanceMetrics')">
                    <h3><i class="fas fa-tachometer-alt"></i> Performance Metrics</h3>
                    <i class="fas fa-chevron-down" id="performanceMetricsIcon"></i>
                </div>
                <div class="section-content" id="performanceMetricsContent">
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Latency Metrics</h4>
                            <div id="latencyMetrics"></div>
                        </div>
                        <div class="info-card">
                            <h4>LLM Token Usage</h4>
                            <div id="tokenUsageMetrics"></div>
                        </div>
                        <div class="info-card" style="display: none;">
                            <h4>Call Cost</h4>
                            <div id="callCostMetrics"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Information Section -->
            <div class="comprehensive-section" id="systemInfoSection" style="display: none;">
                <div class="section-header" onclick="toggleSection('systemInfo')">
                    <h3><i class="fas fa-server"></i> System Information</h3>
                    <i class="fas fa-chevron-down" id="systemInfoIcon"></i>
                </div>
                <div class="section-content" id="systemInfoContent">
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Telephony Provider</h4>
                            <div id="telephonyInfo"></div>
                        </div>
                        <div class="info-card">
                            <h4>Data Storage</h4>
                            <div id="dataStorageInfo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const callId = window.location.pathname.split('/').pop();

        // Load call details
        async function loadCallDetails() {
            try {
                const response = await fetch(`/dashboard/api/call/${callId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success && data.call) {
                    renderCallDetails(data.call);
                } else {
                    document.getElementById('loadingState').innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Call not found</div>
                    `;
                }
            } catch (error) {
                console.error('Error loading call details:', error);
                document.getElementById('loadingState').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Error loading call details</div>
                `;
            }
        }

        // Render call details
        function renderCallDetails(call) {
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';

            // Status banner
            const isSuccess = call.update_successful === 1 || call.update_successful === true;
            const statusBanner = document.getElementById('statusBanner');
            const statusBadge = document.getElementById('statusBadge');
            
            if (isSuccess) {
                statusBanner.className = 'status-banner success';
                statusBanner.querySelector('h2').textContent = 'Payment Update Successful';
                statusBanner.querySelector('p').textContent = 'Credit card information has been successfully updated in the customer\'s account.';
                statusBadge.className = 'status-badge success';
                statusBadge.textContent = 'SUCCESS';
            } else {
                statusBanner.className = 'status-banner error';
                statusBanner.querySelector('h2').textContent = 'Payment Update Failed';
                statusBanner.querySelector('p').textContent = call.error_message || 'The payment update could not be completed. Please review the error details below.';
                statusBadge.className = 'status-badge error';
                statusBadge.textContent = 'FAILED';
                
                // Show error card with both technical and actionable messages
                if (call.error_message) {
                    document.getElementById('errorCard').style.display = 'block';
                    const errorHtml = formatErrorForCallDetails(call.error_message);
                    document.getElementById('errorMessage').innerHTML = errorHtml;
                }
            }

            // Call information
            document.getElementById('callId').textContent = call.call_id || '-';
            document.getElementById('callDateTime').textContent = formatDateTime(call.call_date, call.call_time);
            document.getElementById('callDuration').textContent = formatDuration(call.call_duration || 0);
            document.getElementById('callerNumber').textContent = formatPhoneNumber(call.caller_number);
            document.getElementById('callerName').textContent = call.caller_name || call.cardholder_name || 'Not provided';

            // Payment information
            document.getElementById('cardType').textContent = formatCardType(call.card_type) || '-';
            document.getElementById('cardLast4').textContent = call.card_last_4 ? `•••• ${call.card_last_4}` : '-';
            document.getElementById('cardExpiry').textContent = (call.card_expiry_month && call.card_expiry_year) 
                ? `${call.card_expiry_month}/${call.card_expiry_year}` 
                : '-';
            document.getElementById('cardholderName').textContent = call.cardholder_name || '-';
            document.getElementById('language').textContent = call.language_used || 'en';

            // Transcript
            if (call.transcript) {
                renderTranscript(call.transcript);
            } else {
                document.getElementById('transcriptContainer').innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-comment-slash"></i>
                        <div>No transcript available</div>
                    </div>
                `;
            }

            // Populate comprehensive data
            populateComprehensiveData(call);

            // Extract and display webhook data in professional format
            populateWebhookData(call);
        }

        // Populate comprehensive Nucleus AI data
        function populateComprehensiveData(call) {
            // Core Call Data
            if (call.call_type || call.call_status || call.direction || call.from_number || call.to_number || call.disconnection_reason || 
                call.agent_id || call.agent_name || call.agent_version || call.start_timestamp || call.end_timestamp || call.duration_ms) {
                document.getElementById('coreCallDataSection').style.display = 'block';
                
                document.getElementById('callType').textContent = call.call_type || '-';
                document.getElementById('callStatus').textContent = call.call_status || '-';
                document.getElementById('direction').textContent = call.direction || '-';
                document.getElementById('fromNumber').textContent = formatPhoneNumber(call.from_number || call.caller_number || '-');
                document.getElementById('toNumber').textContent = formatPhoneNumber(call.to_number || '-');
                document.getElementById('disconnectionReason').textContent = call.disconnection_reason || '-';
                
                document.getElementById('agentId').textContent = call.agent_id || '-';
                document.getElementById('agentName').textContent = call.agent_name || '-';
                document.getElementById('agentVersion').textContent = call.agent_version || '-';
                document.getElementById('startTimestamp').textContent = call.start_timestamp 
                    ? formatTimestamp(call.start_timestamp) : '-';
                document.getElementById('endTimestamp').textContent = call.end_timestamp 
                    ? formatTimestamp(call.end_timestamp) : '-';
                document.getElementById('durationMs').textContent = call.duration_ms 
                    ? `${call.duration_ms.toLocaleString()}ms (${formatDuration(Math.floor(call.duration_ms / 1000))})` : '-';
            }

            // Transcript & Recording Data
            if (call.recording_url || call.recording_multi_channel_url || call.scrubbed_recording_url || 
                call.transcript_object || call.transcript_with_tool_calls || call.scrubbed_transcript_with_tool_calls) {
                document.getElementById('transcriptRecordingSection').style.display = 'block';
                
                if (call.recording_url) {
                    document.getElementById('recordingUrlRow').style.display = 'flex';
                    document.getElementById('recordingUrl').href = call.recording_url;
                }
                if (call.recording_multi_channel_url) {
                    document.getElementById('recordingMultiChannelRow').style.display = 'flex';
                    document.getElementById('recordingMultiChannelUrl').href = call.recording_multi_channel_url;
                }
                if (call.scrubbed_recording_url) {
                    document.getElementById('scrubbedRecordingRow').style.display = 'flex';
                    document.getElementById('scrubbedRecordingUrl').href = call.scrubbed_recording_url;
                }
                if (call.scrubbed_recording_multi_channel_url) {
                    document.getElementById('scrubbedMultiChannelRow').style.display = 'flex';
                    document.getElementById('scrubbedMultiChannelUrl').href = call.scrubbed_recording_multi_channel_url;
                }
                
                if (call.transcript_object) {
                    document.getElementById('transcriptObjectRow').style.display = 'flex';
                    window.transcriptObject = call.transcript_object;
                }
                if (call.transcript_with_tool_calls) {
                    document.getElementById('transcriptToolCallsRow').style.display = 'flex';
                    window.transcriptWithToolCalls = call.transcript_with_tool_calls;
                }
                if (call.scrubbed_transcript_with_tool_calls) {
                    document.getElementById('scrubbedTranscriptRow').style.display = 'flex';
                    window.scrubbedTranscript = call.scrubbed_transcript_with_tool_calls;
                }
                
                // Check webhook data for additional recording URLs
                let webhookData = null;
                if (call.webhook_data) {
                    try {
                        webhookData = typeof call.webhook_data === 'string' 
                            ? JSON.parse(call.webhook_data) 
                            : call.webhook_data;
                    } catch (e) {}
                }
                
                const callData = webhookData?.call || call;
                
                if (callData?.public_log_url) {
                    document.getElementById('publicLogRow').style.display = 'flex';
                    document.getElementById('publicLogUrl').href = callData.public_log_url;
                }
                
                if (callData?.scrubbed_public_log_url) {
                    document.getElementById('scrubbedPublicLogRow').style.display = 'flex';
                    document.getElementById('scrubbedPublicLogUrl').href = callData.scrubbed_public_log_url;
                }
            }

            // Analysis & Insights
            if (call.call_successful !== undefined || call.user_sentiment || call.in_voicemail || 
                call.call_summary || call.call_analysis || call.custom_analysis_data) {
                document.getElementById('analysisSection').style.display = 'block';
                
                document.getElementById('callSuccessful').textContent = call.call_successful !== undefined 
                    ? (call.call_successful ? 'Yes' : 'No') : '-';
                document.getElementById('userSentiment').textContent = call.user_sentiment || '-';
                document.getElementById('inVoicemail').textContent = call.in_voicemail !== undefined 
                    ? (call.in_voicemail ? 'Yes' : 'No') : '-';
                
                if (call.call_summary) {
                    document.getElementById('callSummaryRow').style.display = 'flex';
                    document.getElementById('callSummary').textContent = call.call_summary;
                }
                
                if (call.call_analysis) {
                    document.getElementById('callAnalysisRow').style.display = 'flex';
                    window.callAnalysis = call.call_analysis;
                }
                
                if (call.custom_analysis_data) {
                    document.getElementById('customAnalysisRow').style.display = 'flex';
                    window.customAnalysis = call.custom_analysis_data;
                }
            }
        }

        // Toggle section visibility
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}Section`);
            const content = document.getElementById(`${sectionName}Content`);
            const icon = document.getElementById(`${sectionName}Icon`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                icon.style.transform = '';
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        // Show detailed data in modal or new window
        function showTranscriptObject() {
            if (window.transcriptObject) {
                const data = typeof window.transcriptObject === 'string' 
                    ? JSON.parse(window.transcriptObject) 
                    : window.transcriptObject;
                showJSONModal('Structured Transcript', data);
            }
        }

        function showTranscriptWithToolCalls() {
            if (window.transcriptWithToolCalls) {
                showTextModal('Transcript with Tool Calls', window.transcriptWithToolCalls);
            }
        }

        function showScrubbedTranscript() {
            if (window.scrubbedTranscript) {
                showTextModal('Scrubbed Transcript (PII Removed)', window.scrubbedTranscript);
            }
        }

        function showCallAnalysis() {
            if (window.callAnalysis) {
                const data = typeof window.callAnalysis === 'string' 
                    ? JSON.parse(window.callAnalysis) 
                    : window.callAnalysis;
                showJSONModal('Call Analysis', data);
            }
        }

        function showCustomAnalysis() {
            if (window.customAnalysis) {
                const data = typeof window.customAnalysis === 'string' 
                    ? JSON.parse(window.customAnalysis) 
                    : window.customAnalysis;
                showJSONModal('Custom Analysis Data', data);
            }
        }

        function showJSONModal(title, data) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 800px; max-height: 90vh; overflow: auto; padding: 24px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">${title}</h3>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: var(--error); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                    <pre style="background: #f5f5f5; padding: 16px; border-radius: 4px; overflow: auto; max-height: 70vh;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showTextModal(title, text) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 800px; max-height: 90vh; overflow: auto; padding: 24px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">${title}</h3>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: var(--error); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                    <div style="background: #f5f5f5; padding: 16px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 70vh; overflow: auto;">${escapeHtml(text)}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/New_York',
                hour12: true
            });
        }

        // Redact credit card numbers in text, showing only last 4 digits
        function redactCreditCardNumbers(text) {
            if (!text) return text;
            
            // First, handle numbers written as words (e.g., "four five two zero three eight...")
            const numberWords = {
                'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4',
                'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9'
            };
            
            // Strategy: Find sequences of 13+ number words, even if separated by punctuation
            // Process the text by finding all number words and checking for sequences
            const numberWordRegex = /\b(zero|one|two|three|four|five|six|seven|eight|nine)\b/gi;
            const allMatches = [];
            let match;
            
            while ((match = numberWordRegex.exec(text)) !== null) {
                allMatches.push({
                    word: match[1].toLowerCase(),
                    index: match.index,
                    length: match[0].length
                });
            }
            
            // Find sequences of 13-19 consecutive number words (within reasonable distance)
            // First, find all sequences, then replace them in reverse order to avoid index shifting
            const sequencesToReplace = [];
            
            for (let i = 0; i <= allMatches.length - 13; i++) {
                // Check if we have a sequence of 13-19 number words
                let sequence = [];
                let currentIndex = allMatches[i].index;
                
                for (let j = i; j < Math.min(i + 19, allMatches.length); j++) {
                    const distance = allMatches[j].index - currentIndex;
                    // Allow up to 50 characters between words (for punctuation/spacing)
                    if (distance <= 50 || j === i) {
                        sequence.push(allMatches[j]);
                        currentIndex = allMatches[j].index + allMatches[j].length;
                    } else {
                        break;
                    }
                }
                
                // If we have 13-19 words, this might be a credit card
                if (sequence.length >= 13 && sequence.length <= 19) {
                    const digits = sequence.map(m => numberWords[m.word]).join('');
                    if (digits.length >= 13 && digits.length <= 19) {
                        const startIndex = sequence[0].index;
                        const endIndex = sequence[sequence.length - 1].index + sequence[sequence.length - 1].length;
                        const last4 = digits.slice(-4);
                        
                        sequencesToReplace.push({
                            startIndex: startIndex,
                            endIndex: endIndex,
                            replacement: `**** **** **** ${last4}`,
                            processedIndices: sequence.map(s => s.index)
                        });
                        
                        // Skip ahead to avoid overlapping sequences
                        i += sequence.length - 1;
                    }
                }
            }
            
            // Replace all sequences in reverse order (from end to start) to avoid index shifting
            for (let i = sequencesToReplace.length - 1; i >= 0; i--) {
                const seq = sequencesToReplace[i];
                text = text.substring(0, seq.startIndex) + 
                       seq.replacement + 
                       text.substring(seq.endIndex);
            }
            
            // Now handle numeric credit card numbers (13-19 digits, with optional spaces/dashes)
            // Patterns: 1234567890123456, 1234 5678 9012 3456, 1234-5678-9012-3456
            const creditCardRegex = /\b(?:\d[ -]?){13,19}\b/g;
            
            return text.replace(creditCardRegex, (match) => {
                // Remove all non-digits
                const digits = match.replace(/\D/g, '');
                
                // Only redact if it's 13-19 digits (likely a credit card)
                if (digits.length >= 13 && digits.length <= 19) {
                    // Extract last 4 digits
                    const last4 = digits.slice(-4);
                    // Return redacted version with original spacing pattern if present
                    const hasSpaces = match.includes(' ');
                    const hasDashes = match.includes('-');
                    
                    if (hasSpaces) {
                        return `**** **** **** ${last4}`;
                    } else if (hasDashes) {
                        return `****-****-****-${last4}`;
                    } else {
                        return `****${last4}`;
                    }
                }
                
                // Return original if it doesn't match card pattern
                return match;
            });
        }

        // Render transcript
        function renderTranscript(transcriptText) {
            const container = document.getElementById('transcriptContainer');
            
            // Redact credit card numbers before parsing
            const redactedTranscript = redactCreditCardNumbers(transcriptText);
            
            // Parse transcript into messages
            const messages = parseTranscript(redactedTranscript);
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div>Unable to parse transcript</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.speaker}">
                    <div class="message-avatar">${msg.speaker === 'agent' ? 'AI' : 'U'}</div>
                    <div style="flex: 1;">
                        <div class="message-bubble">${escapeHtml(msg.text)}</div>
                        ${msg.timestamp ? `<div class="message-time">${formatTime(msg.timestamp)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Parse transcript into messages
        function parseTranscript(transcript) {
            if (!transcript) return [];
            
            const messages = [];
            const lines = transcript.split('\n').filter(l => l.trim());
            
            let currentSpeaker = null;
            let currentText = [];
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                const agentMatch = trimmed.match(/^(Agent|Nova|Fona|AI|Assistant|System):\s*(.+)/i);
                const userMatch = trimmed.match(/^(User|Caller|Customer|Human):\s*(.+)/i);
                
                if (agentMatch) {
                    if (currentSpeaker && currentText.length > 0) {
                        messages.push({
                            speaker: currentSpeaker,
                            text: redactCreditCardNumbers(currentText.join(' ').trim()),
                            timestamp: null
                        });
                    }
                    currentSpeaker = 'agent';
                    currentText = [agentMatch[2]];
                } else if (userMatch) {
                    if (currentSpeaker && currentText.length > 0) {
                        messages.push({
                            speaker: currentSpeaker,
                            text: redactCreditCardNumbers(currentText.join(' ').trim()),
                            timestamp: null
                        });
                    }
                    currentSpeaker = 'customer';
                    currentText = [userMatch[2]];
                } else {
                    if (currentSpeaker) {
                        currentText.push(trimmed);
                    } else {
                        currentSpeaker = 'agent';
                        currentText = [trimmed];
                    }
                }
            });
            
            if (currentSpeaker && currentText.length > 0) {
                messages.push({
                    speaker: currentSpeaker,
                    text: redactCreditCardNumbers(currentText.join(' ').trim()),
                    timestamp: null
                });
            }
            
            return messages;
        }

        // Extract and populate webhook data in professional CRM format
        function populateWebhookData(call) {
            let webhookData = null;
            
            // Try to parse webhook_data
            if (call.webhook_data) {
                try {
                    webhookData = typeof call.webhook_data === 'string' 
                        ? JSON.parse(call.webhook_data) 
                        : call.webhook_data;
                } catch (e) {
                    console.warn('Could not parse webhook_data:', e);
                }
            }
            
            // Extract from call object if webhook_data not available
            const callData = webhookData?.call || call;
            
            // Performance Metrics
            if (callData?.latency || callData?.llm_token_usage || callData?.call_cost || 
                call.latency_data || call.llm_token_usage || call.call_cost_data) {
                document.getElementById('performanceMetricsSection').style.display = 'block';
                populatePerformanceMetrics(callData, call);
            }
            
            // System Information
            if (callData?.telephony_identifier || callData?.opt_in_signed_url !== undefined || 
                callData?.data_storage_setting || callData?.opt_out_sensitive_data_storage !== undefined) {
                document.getElementById('systemInfoSection').style.display = 'block';
                populateSystemInfo(callData, call);
            }
        }
        
        // Populate Performance Metrics section
        function populatePerformanceMetrics(callData, call) {
            const latencyContainer = document.getElementById('latencyMetrics');
            const tokenContainer = document.getElementById('tokenUsageMetrics');
            const costContainer = document.getElementById('callCostMetrics');
            
            // Latency Metrics
            let latency = callData?.latency || null;
            if (!latency && call.latency_data) {
                try {
                    latency = typeof call.latency_data === 'string' ? JSON.parse(call.latency_data) : call.latency_data;
                } catch (e) {
                    console.warn('Could not parse latency_data:', e);
                }
            }
            if (latency) {
                let latencyHtml = '';
                
                if (latency.llm) {
                    latencyHtml += `
                        <div class="info-row">
                            <span class="info-label">LLM Latency</span>
                            <span class="info-value">P50: ${latency.llm.p50}ms | P90: ${latency.llm.p90}ms</span>
                        </div>
                        ${latency.llm.min !== undefined ? `<div class="info-row"><span class="info-label">LLM Min/Max</span><span class="info-value">${latency.llm.min}ms / ${latency.llm.max}ms</span></div>` : ''}
                        ${latency.llm.num !== undefined ? `<div class="info-row"><span class="info-label">LLM Samples</span><span class="info-value">${latency.llm.num}</span></div>` : ''}
                    `;
                }
                if (latency.e2e) {
                    latencyHtml += `
                        <div class="info-row">
                            <span class="info-label">End-to-End</span>
                            <span class="info-value">P50: ${latency.e2e.p50}ms | P90: ${latency.e2e.p90}ms</span>
                        </div>
                        ${latency.e2e.min !== undefined ? `<div class="info-row"><span class="info-label">E2E Min/Max</span><span class="info-value">${latency.e2e.min}ms / ${latency.e2e.max}ms</span></div>` : ''}
                        ${latency.e2e.num !== undefined ? `<div class="info-row"><span class="info-label">E2E Samples</span><span class="info-value">${latency.e2e.num}</span></div>` : ''}
                    `;
                }
                if (latency.tts) {
                    latencyHtml += `
                        <div class="info-row">
                            <span class="info-label">Text-to-Speech</span>
                            <span class="info-value">P50: ${latency.tts.p50}ms | P90: ${latency.tts.p90}ms</span>
                        </div>
                        ${latency.tts.min !== undefined ? `<div class="info-row"><span class="info-label">TTS Min/Max</span><span class="info-value">${latency.tts.min}ms / ${latency.tts.max}ms</span></div>` : ''}
                        ${latency.tts.num !== undefined ? `<div class="info-row"><span class="info-label">TTS Samples</span><span class="info-value">${latency.tts.num}</span></div>` : ''}
                    `;
                }
                
                latencyContainer.innerHTML = latencyHtml || '<div class="info-row"><span class="info-label">No latency data</span></div>';
            } else {
                latencyContainer.innerHTML = '<div class="info-row"><span class="info-label">No latency data available</span></div>';
            }
            
            // Token Usage
            let tokenUsage = callData?.llm_token_usage || null;
            if (!tokenUsage && call.llm_token_usage) {
                try {
                    tokenUsage = typeof call.llm_token_usage === 'string' ? JSON.parse(call.llm_token_usage) : call.llm_token_usage;
                } catch (e) {
                    console.warn('Could not parse llm_token_usage:', e);
                }
            }
            if (tokenUsage) {
                tokenContainer.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Average Tokens</span>
                        <span class="info-value">${tokenUsage.average || (tokenUsage.values && tokenUsage.values.length > 0 ? Math.round(tokenUsage.values.reduce((a, b) => a + b, 0) / tokenUsage.values.length) : 'N/A')}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Requests</span>
                        <span class="info-value">${tokenUsage.num_requests || (tokenUsage.values ? tokenUsage.values.length : 'N/A')}</span>
                    </div>
                `;
            } else {
                tokenContainer.innerHTML = '<div class="info-row"><span class="info-label">No token usage data</span></div>';
            }
            
            // Call Cost
            let callCost = callData?.call_cost || null;
            if (!callCost && call.call_cost_data) {
                try {
                    callCost = typeof call.call_cost_data === 'string' ? JSON.parse(call.call_cost_data) : call.call_cost_data;
                } catch (e) {
                    console.warn('Could not parse call_cost_data:', e);
                }
            }
            if (callCost) {
                let costHtml = '';
                
                // Calculate duration in minutes
                const durationSeconds = callCost.total_duration_seconds || 0;
                const durationMinutes = durationSeconds / 60;
                
                // NOTE: combined_cost appears to be in CENTS, not dollars
                // We need to divide by 100 to convert to dollars
                const combinedCostInDollars = callCost.combined_cost ? callCost.combined_cost / 100 : null;
                
                // Get total cost per minute (if available) or calculate from combined_cost
                // total_duration_unit_price is in cents per second, so convert to dollars per minute
                const costPerMinute = callCost.total_duration_unit_price ? (callCost.total_duration_unit_price / 100) * 60 : 
                                     (combinedCostInDollars && durationMinutes > 0 ? combinedCostInDollars / durationMinutes : null);
                
                // Display cost per minute breakdown
                // NOTE: Nucleus AI sends unit_price as per SECOND, not per minute
                // We need to convert to per-minute for display
                if (callCost.product_costs && Array.isArray(callCost.product_costs)) {
                    let totalPerMinute = 0;
                    
                    callCost.product_costs.forEach(product => {
                        // unit_price is in CENTS per SECOND
                        // Convert: cents/sec ÷ 100 × 60 = dollars/min
                        // Or: cents/sec × 0.6 = dollars/min
                        const unitPricePerSecondInCents = product.unit_price;
                        const unitPricePerMinuteInDollars = unitPricePerSecondInCents ? (unitPricePerSecondInCents / 100) * 60 : null;
                        
                        // product.cost is in CENTS, convert to dollars
                        const productCostInDollars = product.cost ? product.cost / 100 : null;
                        
                        if (unitPricePerMinuteInDollars !== null) {
                            totalPerMinute += unitPricePerMinuteInDollars;
                        }
                        
                        // Display the cost breakdown
                        costHtml += `
                            <div class="info-row">
                                <span class="info-label">${formatProductName(product.product)}</span>
                                <span class="info-value">
                                    ${unitPricePerMinuteInDollars !== null ? `$${unitPricePerMinuteInDollars.toFixed(3)}/min` : ''}
                                    ${productCostInDollars !== null ? ` ($${productCostInDollars.toFixed(3)})` : ''}
                                </span>
                            </div>
                        `;
                    });
                    
                    // Calculate total cost per minute from total_duration_unit_price (which is in cents per second)
                    let displayPerMinute = null;
                    if (callCost.total_duration_unit_price) {
                        // Convert: cents/sec ÷ 100 × 60 = dollars/min
                        displayPerMinute = (callCost.total_duration_unit_price / 100) * 60;
                    } else if (totalPerMinute > 0) {
                        displayPerMinute = totalPerMinute;
                    } else if (costPerMinute) {
                        displayPerMinute = costPerMinute;
                    }
                    
                    if (displayPerMinute !== null) {
                        costHtml += `
                            <div class="info-row" style="border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px;">
                                <span class="info-label" style="font-weight: 600;">Total Cost per Minute</span>
                                <span class="info-value" style="font-weight: 600;">$${displayPerMinute.toFixed(3)}/min</span>
                            </div>
                        `;
                    }
                }
                
                // Display call duration
                if (durationSeconds > 0) {
                    const minutes = Math.floor(durationSeconds / 60);
                    const seconds = durationSeconds % 60;
                    const durationFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    const durationDecimal = durationMinutes.toFixed(3);
                    
                    costHtml += `
                        <div class="info-row" style="margin-top: 12px;">
                            <span class="info-label">Call Duration</span>
                            <span class="info-value">${durationFormatted} (${durationDecimal} min)</span>
                        </div>
                    `;
                }
                
                // Display total cost (convert from cents to dollars)
                if (combinedCostInDollars !== null) {
                    costHtml += `
                        <div class="info-row" style="border-top: 2px solid var(--primary); margin-top: 12px; padding-top: 12px;">
                            <span class="info-label" style="font-weight: 700; font-size: 16px;">Total Cost</span>
                            <span class="info-value" style="color: var(--primary); font-weight: 700; font-size: 16px;">$${combinedCostInDollars.toFixed(3)}</span>
                        </div>
                    `;
                }
                
                costContainer.innerHTML = costHtml || '<div class="info-row"><span class="info-label">No cost data</span></div>';
            } else {
                costContainer.innerHTML = '<div class="info-row"><span class="info-label">No cost data available</span></div>';
            }
        }
        
        // Populate System Information section
        function populateSystemInfo(callData, call) {
            const telephonyContainer = document.getElementById('telephonyInfo');
            const storageContainer = document.getElementById('dataStorageInfo');
            
            // Telephony Provider Info
            const telephony = callData?.telephony_identifier || {};
            if (telephony.twilio_call_sid || callData?.from_number) {
                let telephonyHtml = '';
                
                if (telephony.twilio_call_sid) {
                    telephonyHtml += `
                        <div class="info-row">
                            <span class="info-label">Twilio Call SID</span>
                            <span class="info-value" style="font-family: monospace; font-size: 12px;">${telephony.twilio_call_sid}</span>
                        </div>
                    `;
                }
                
                telephonyContainer.innerHTML = telephonyHtml || '<div class="info-row"><span class="info-label">No telephony data</span></div>';
            } else {
                telephonyContainer.innerHTML = '<div class="info-row"><span class="info-label">No telephony data available</span></div>';
            }
            
            // Data Storage Settings
            let storageHtml = '';
            
            if (callData?.data_storage_setting !== undefined) {
                storageHtml += `
                    <div class="info-row">
                        <span class="info-label">Storage Setting</span>
                        <span class="info-value">${callData.data_storage_setting}</span>
                    </div>
                `;
            }
            
            if (callData?.opt_out_sensitive_data_storage !== undefined) {
                storageHtml += `
                    <div class="info-row">
                        <span class="info-label">Opt Out Sensitive Data</span>
                        <span class="info-value">${callData.opt_out_sensitive_data_storage ? 'Yes' : 'No'}</span>
                    </div>
                `;
            }
            
            if (callData?.opt_in_signed_url !== undefined) {
                storageHtml += `
                    <div class="info-row">
                        <span class="info-label">Opt In Signed URL</span>
                        <span class="info-value">${callData.opt_in_signed_url ? 'Yes' : 'No'}</span>
                    </div>
                `;
            }
            
            storageContainer.innerHTML = storageHtml || '<div class="info-row"><span class="info-label">No storage settings</span></div>';
        }
        
        // Format product name for display
        function formatProductName(product) {
            const names = {
                'elevenlabs_tts': 'ElevenLabs TTS',
                'gpt_4_1': 'GPT-4.1',
                'canada_twilio_telephony': 'Twilio Telephony (Canada)',
                'pii_scrubbing': 'PII Scrubbing'
            };
            return names[product] || product;
        }

        // Format functions
        function formatDateTime(date, time) {
            if (!date) return '-';
            // Parse as UTC since database stores in UTC
            const d = new Date(`${date}T${time || '00:00:00'}Z`);
            return d.toLocaleString('en-US', { 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/New_York',
                hour12: true
            });
        }

        function formatPhoneNumber(num) {
            if (!num) return '-';
            const cleaned = num.replace(/\D/g, '');
            if (cleaned.length === 10) {
                return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
            }
            return num;
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0:00';
            if (seconds > 7200) seconds = Math.floor(seconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function formatCardType(type) {
            if (!type) return '';
            const types = {
                'visa': 'Visa',
                'mastercard': 'Mastercard',
                'amex': 'American Express'
            };
            return types[type.toLowerCase()] || type;
        }

        // Format error message for call details page
        // Shows both technical error (for billing) and actionable message (for clarity)
        function formatErrorForCallDetails(errorMessage) {
            if (!errorMessage) return '';
            
            // If error contains " | " separator, split into technical and actionable
            if (errorMessage.includes(' | ')) {
                const parts = errorMessage.split(' | ');
                const technical = parts[0].trim();
                const actionable = parts[1] ? parts[1].trim() : '';
                
                // Show technical error prominently for billing department
                // Then show actionable message below for context
                if (actionable && actionable !== technical) {
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="font-weight: 600; color: var(--error); margin-bottom: 8px; font-size: 16px;">
                                <i class="fas fa-exclamation-circle"></i> Technical Error
                            </div>
                            <div style="background: #fff3f3; padding: 12px; border-radius: 4px; border-left: 3px solid var(--error); margin-bottom: 12px;">
                                ${escapeHtml(technical)}
                            </div>
                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">
                                What this means for the caller:
                            </div>
                            <div style="background: #f9f9f9; padding: 12px; border-radius: 4px; color: var(--text-secondary);">
                                ${escapeHtml(actionable)}
                            </div>
                        </div>
                    `;
                } else {
                    return `<div style="background: #fff3f3; padding: 12px; border-radius: 4px; border-left: 3px solid var(--error);">${escapeHtml(technical)}</div>`;
                }
            }
            
            // Fallback: just show the error message
            return `<div style="background: #fff3f3; padding: 12px; border-radius: 4px; border-left: 3px solid var(--error);">${escapeHtml(errorMessage)}</div>`;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/New_York',
                hour12: true
            });
        }

        // Initialize
        loadCallDetails();
    </script>
</body>
</html>
